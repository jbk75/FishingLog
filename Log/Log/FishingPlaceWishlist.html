<html>
<head>
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap-datepicker.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap-year-calendar.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Content-Type" content="text/html; charset=utf-8">
    <meta name="title" content="Fishing place wishlist">

    <title>Fishing place wishlist</title>

    <script src="Scripts/respond.min.js"></script>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <script src="Scripts/bootstrap-datepicker.min.js"></script>
    <script src="Scripts/bootstrap-year-calendar.min.js"></script>
    <script src="Scripts/bootstrap-popover.js"></script>
    <script src="Scripts/scripts.js"></script>
    <script src="Dal.js"></script>
    <script src="Dates.js"></script>
    <style>
        #wishlistTable th.sortable {
            cursor: pointer;
        }

        #wishlistTable .sort-indicator {
            font-size: 10px;
            margin-left: 4px;
        }

        #wishlistTable .wishlist-description {
            width: 100%;
            min-width: 220px;
        }

        #wishlistTable .wishlist-action {
            white-space: nowrap;
            width: 1%;
        }
    </style>
</head>
<body>
    <a class="home-link" href="CalFull.html" aria-label="Home">
        <span class="fa fa-home" aria-hidden="true"></span>
    </a>

    <div class="sub-content-container">
        <div class="sub-content">
            <div class="panel panel-default main-panel">
                <div class="panel-heading calendar-menu">
                    <div class="calendar-menu__title">
                        <span class="calendar-menu__title-text"><b>Fishing place wishlist</b></span>
                        <span class="calendar-menu__subtitle">Collect locations to explore next.</span>
                    </div>
                    <div class="calendar-menu__actions btn-group btn-group-sm" role="group" aria-label="Navigation">
                        <button class="btn btn-default" onclick="location.href='CalFull.html'">Fishing calendar</button>
                        <button class="btn btn-default" onclick="location.href='FishingPlaces.html'">Fishing places list</button>
                        <button class="btn btn-default" onclick="location.href='FishingPlaceSpots.html'">Fishing place spots</button>
                        <button class="btn btn-default active" onclick="location.href='FishingPlaceWishlist.html'">Fishing place wishlist</button>
                        <button class="btn btn-default" onclick="location.href='IcelandFishingMap.html'">Iceland map</button>
                        <button class="btn btn-default" onclick="location.href='WeatherHistory.html'">Weather history</button>
                        <button class="btn btn-default" onclick="location.href='Tides.html'">Tides</button>
                        <button class="btn btn-default" onclick="location.href='SuggestedFishingTrips.html'">Suggested trips</button>
                        <button class="btn btn-default" onclick="location.href='fishingnews.html'">Fishing news</button>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="panel panel-info">
                        <div class="panel-heading"><b>Add to wishlist</b></div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label for="existingFishingPlace">Choose fishing place</label>
                                <select id="existingFishingPlace" class="form-control">
                                    <option value="">-- Select existing fishing place --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newFishingPlaceName">Or add a new fishing place</label>
                                <input type="text" id="newFishingPlaceName" class="form-control" placeholder="New fishing place name" />
                            </div>
                            <div class="form-group">
                                <label for="fishingPlaceType">Type</label>
                                <select id="fishingPlaceType" class="form-control">
                                    <option value="">-- Select type --</option>
                                    <option value="2">River</option>
                                    <option value="1">Lake</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="wishlistDescription">Description</label>
                                <textarea id="wishlistDescription" class="form-control" rows="3" placeholder="Describe the fishing place"></textarea>
                            </div>
                            <button id="saveWishlist" class="btn btn-primary">Save</button>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading"><b>Wishlist</b></div>
                        <div class="panel-body">
                            <table class="table table-striped" id="wishlistTable">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="fishingPlaceName">Name<span class="sort-indicator"></span></th>
                                        <th class="sortable" data-sort="fishingPlaceTypeName">Type<span class="sort-indicator"></span></th>
                                        <th class="sortable" data-sort="description">Description<span class="sort-indicator"></span></th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var wishlistData = [];
        var wishlistSortState = {
            key: 'fishingPlaceName',
            direction: 'asc'
        };

        $(document).ready(function () {
            loadFishingPlaces();
            loadWishlist();

            $('#existingFishingPlace').on('change', function () {
                var type = $('option:selected', this).data('type');
                if (type) {
                    $('#fishingPlaceType').val(type);
                } else {
                    $('#fishingPlaceType').val('');
                }
                if ($(this).val()) {
                    $('#newFishingPlaceName').val('');
                }
            });

            $('#newFishingPlaceName').on('input', function () {
                if ($(this).val().length > 0) {
                    $('#existingFishingPlace').val('');
                }
            });

            $('#newFishingPlaceName').on('blur', function () {
                var nameValue = $(this).val().trim().toLowerCase();
                if (!nameValue) {
                    return;
                }

                if (nameValue.indexOf('vatn') !== -1) {
                    $('#fishingPlaceType').val('1');
                } else if (nameValue.indexOf('á') !== -1) {
                    $('#fishingPlaceType').val('2');
                }
            });

            $('#saveWishlist').on('click', function () {
                saveWishlistItem();
            });

            $('#wishlistTable thead').on('click', 'th.sortable', function () {
                var newKey = $(this).data('sort');
                if (wishlistSortState.key === newKey) {
                    wishlistSortState.direction = wishlistSortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    wishlistSortState.key = newKey;
                    wishlistSortState.direction = 'asc';
                }
                renderWishlist();
            });

            $('#wishlistTable tbody').on('click', '.wishlist-save', function () {
                var row = $(this).closest('tr');
                var id = Number(row.data('id'));
                var description = row.find('.wishlist-description').val().trim();
                updateWishlistDescription(id, description, row);
            });
        });

        function loadFishingPlaces() {
            $('#existingFishingPlace').empty();
            $('#existingFishingPlace').append('<option value=\"\">-- Select existing fishing place --</option>');

            $.ajax({
                url: APIBaseUrl + 'veidistadur',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    jQuery.each(data, function (i, val) {
                        var option = $('<option>')
                            .attr('value', val.id)
                            .text(val.name);

                        var typeVal = val.fishingPlaceTypeID || val.fishingPlaceTypeId;
                        if (typeVal) {
                            option.attr('data-type', typeVal);
                        }
                        $('#existingFishingPlace').append(option);
                    });
                },
                error: function () {
                    alert('Failed to load fishing places.');
                }
            });
        }

        function loadWishlist() {
            $.ajax({
                url: APIBaseUrl + 'FishingPlaceWishlist',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    wishlistData = data || [];
                    renderWishlist();
                },
                error: function () {
                    alert('Failed to load wishlist.');
                }
            });
        }

        function renderWishlist() {
            var tbody = $('#wishlistTable tbody');
            tbody.empty();

            if (!wishlistData || wishlistData.length === 0) {
                tbody.append('<tr><td colspan=\"4\">No wishlist items found.</td></tr>');
                updateSortIndicators();
                return;
            }

            var sortedData = wishlistData.slice().sort(function (a, b) {
                var key = wishlistSortState.key;
                var direction = wishlistSortState.direction === 'asc' ? 1 : -1;
                var valueA = getSortValue(a, key);
                var valueB = getSortValue(b, key);

                if (valueA < valueB) return -1 * direction;
                if (valueA > valueB) return 1 * direction;
                return 0;
            });

            jQuery.each(sortedData, function (i, val) {
                var row = $('<tr>').attr('data-id', val.id);
                row.append($('<td>').text(val.fishingPlaceName));
                row.append($('<td>').text(val.fishingPlaceTypeName || formatType(val.fishingPlaceTypeId)));

                var descriptionCell = $('<td>');
                var descriptionInput = $('<textarea>')
                    .addClass('form-control wishlist-description')
                    .attr('rows', 2)
                    .val(val.description || '');
                descriptionCell.append(descriptionInput);
                row.append(descriptionCell);

                var actionCell = $('<td>').addClass('wishlist-action');
                var saveButton = $('<button>')
                    .addClass('btn btn-xs btn-primary wishlist-save')
                    .text('Save');
                actionCell.append(saveButton);
                row.append(actionCell);

                tbody.append(row);
            });

            updateSortIndicators();
        }

        function getSortValue(item, key) {
            if (key === 'fishingPlaceTypeName') {
                return (item.fishingPlaceTypeName || formatType(item.fishingPlaceTypeId) || '').toLowerCase();
            }
            if (key === 'fishingPlaceName') {
                return (item.fishingPlaceName || '').toLowerCase();
            }
            if (key === 'description') {
                return (item.description || '').toLowerCase();
            }
            return '';
        }

        function updateSortIndicators() {
            $('#wishlistTable thead th.sortable').each(function () {
                var indicator = $(this).find('.sort-indicator');
                if ($(this).data('sort') === wishlistSortState.key) {
                    indicator.text(wishlistSortState.direction === 'asc' ? '▲' : '▼');
                } else {
                    indicator.text('');
                }
            });
        }

        function saveWishlistItem() {
            var selectedId = $('#existingFishingPlace').val();
            var newName = $('#newFishingPlaceName').val().trim();
            var typeId = $('#fishingPlaceType').val();
            var description = $('#wishlistDescription').val().trim();

            if (!selectedId && !newName) {
                alert('Please select a fishing place or enter a new one.');
                return;
            }

            if (!typeId) {
                alert('Please choose whether it is a river or a lake.');
                return;
            }

            var payload = {
                fishingPlaceId: selectedId ? Number(selectedId) : null,
                fishingPlaceName: newName || null,
                fishingPlaceTypeId: Number(typeId),
                description: description
            };

            $.ajax({
                url: APIBaseUrl + 'FishingPlaceWishlist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function () {
                    $('#newFishingPlaceName').val('');
                    $('#existingFishingPlace').val('');
                    $('#wishlistDescription').val('');
                    $('#fishingPlaceType').val('');
                    loadWishlist();
                    loadFishingPlaces();
                },
                error: function () {
                    alert('Could not save wishlist item.');
                }
            });
        }

        function updateWishlistDescription(id, description, row) {
            if (!id) {
                alert('Could not find wishlist item.');
                return;
            }

            $.ajax({
                url: APIBaseUrl + 'FishingPlaceWishlist/' + id,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ description: description }),
                success: function () {
                    var item = wishlistData.find(function (entry) {
                        return entry.id === id;
                    });
                    if (item) {
                        item.description = description;
                    }
                    row.addClass('success');
                    setTimeout(function () {
                        row.removeClass('success');
                    }, 1200);
                },
                error: function () {
                    alert('Could not update wishlist item.');
                }
            });
        }

        function formatType(typeId) {
            if (typeId === 2) return 'River';
            if (typeId === 1) return 'Lake';
            return 'Unknown';
        }
    </script>
</body>
</html>
