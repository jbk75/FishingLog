<html>
<head>
    <link rel="stylesheet" type="text/css" href="scripts/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="scripts/bootstrap-datepicker.min.css">
    <link rel="stylesheet" type="text/css" href="scripts/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="scripts/bootstrap-year-calendar.min.css">
    <link rel="stylesheet" type="text/css" href="scripts/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="scripts/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Content-Type" content="text/html; charset=utf-8">
    <meta name="title" content="Fishing place wishlist">

    <title>Fishing place wishlist</title>

    <script src="scripts/respond.min.js"></script>
    <script src="scripts/jquery-1.10.2.min.js"></script>
    <script src="scripts/bootstrap.min.js"></script>
    <script src="scripts/bootstrap-datepicker.min.js"></script>
    <script src="scripts/bootstrap-year-calendar.min.js"></script>
    <script src="scripts/bootstrap-popover.js"></script>
    <script src="scripts/scripts.js"></script>
    <script src="Dal.js"></script>
    <script src="Dates.js"></script>
</head>
<body>
    <div class="sub-content-container">
        <div class="sub-content">
            <div class="panel panel-default" style="margin:10px;">
                <div class="panel-heading">
                    <b>Fishing place wishlist</b>
                    - <button onclick="location.href='CalFull.html'">Fishing calendar</button>
                    <button onclick="location.href='FishingPlaceSpots.html'">Fishing place spots</button>
                    <button onclick="location.href='FishingPlaces.html'">Fishing places list</button>
                </div>
                <div class="panel-body">
                    <div class="panel panel-info">
                        <div class="panel-heading"><b>Add to wishlist</b></div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label for="existingFishingPlace">Choose fishing place</label>
                                <select id="existingFishingPlace" class="form-control">
                                    <option value="">-- Select existing fishing place --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newFishingPlaceName">Or add a new fishing place</label>
                                <input type="text" id="newFishingPlaceName" class="form-control" placeholder="New fishing place name" />
                            </div>
                            <div class="form-group">
                                <label for="fishingPlaceType">Type</label>
                                <select id="fishingPlaceType" class="form-control">
                                    <option value="">-- Select type --</option>
                                    <option value="2">River</option>
                                    <option value="1">Lake</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="wishlistDescription">Description</label>
                                <textarea id="wishlistDescription" class="form-control" rows="3" placeholder="Describe the fishing place"></textarea>
                            </div>
                            <button id="saveWishlist" class="btn btn-primary">Save</button>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading"><b>Wishlist</b></div>
                        <div class="panel-body">
                            <table class="table table-striped" id="wishlistTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="3">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            loadFishingPlaces();
            loadWishlist();

            $('#existingFishingPlace').on('change', function () {
                var type = $('option:selected', this).data('type');
                if (type) {
                    $('#fishingPlaceType').val(type);
                } else {
                    $('#fishingPlaceType').val('');
                }
                if ($(this).val()) {
                    $('#newFishingPlaceName').val('');
                }
            });

            $('#newFishingPlaceName').on('input', function () {
                if ($(this).val().length > 0) {
                    $('#existingFishingPlace').val('');
                }
            });

            $('#saveWishlist').on('click', function () {
                saveWishlistItem();
            });
        });

        function loadFishingPlaces() {
            $('#existingFishingPlace').empty();
            $('#existingFishingPlace').append('<option value=\"\">-- Select existing fishing place --</option>');

            $.ajax({
                url: APIBaseUrl + 'veidistadur',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    jQuery.each(data, function (i, val) {
                        var option = $('<option>')
                            .attr('value', val.id)
                            .text(val.name);

                        var typeVal = val.fishingPlaceTypeID || val.fishingPlaceTypeId;
                        if (typeVal) {
                            option.attr('data-type', typeVal);
                        }
                        $('#existingFishingPlace').append(option);
                    });
                },
                error: function () {
                    alert('Failed to load fishing places.');
                }
            });
        }

        function loadWishlist() {
            $.ajax({
                url: APIBaseUrl + 'FishingPlaceWishlist',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    var tbody = $('#wishlistTable tbody');
                    tbody.empty();

                    if (!data || data.length === 0) {
                        tbody.append('<tr><td colspan=\"3\">No wishlist items found.</td></tr>');
                        return;
                    }

                    jQuery.each(data, function (i, val) {
                        var row = $('<tr>');
                        row.append($('<td>').text(val.fishingPlaceName));
                        row.append($('<td>').text(val.fishingPlaceTypeName || formatType(val.fishingPlaceTypeId)));
                        row.append($('<td>').text(val.description));
                        tbody.append(row);
                    });
                },
                error: function () {
                    alert('Failed to load wishlist.');
                }
            });
        }

        function saveWishlistItem() {
            var selectedId = $('#existingFishingPlace').val();
            var newName = $('#newFishingPlaceName').val().trim();
            var typeId = $('#fishingPlaceType').val();
            var description = $('#wishlistDescription').val().trim();

            if (!selectedId && !newName) {
                alert('Please select a fishing place or enter a new one.');
                return;
            }

            if (!typeId) {
                alert('Please choose whether it is a river or a lake.');
                return;
            }

            var payload = {
                fishingPlaceId: selectedId ? Number(selectedId) : null,
                fishingPlaceName: newName || null,
                fishingPlaceTypeId: Number(typeId),
                description: description
            };

            $.ajax({
                url: APIBaseUrl + 'FishingPlaceWishlist',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function () {
                    $('#newFishingPlaceName').val('');
                    $('#existingFishingPlace').val('');
                    $('#wishlistDescription').val('');
                    $('#fishingPlaceType').val('');
                    loadWishlist();
                    loadFishingPlaces();
                },
                error: function () {
                    alert('Could not save wishlist item.');
                }
            });
        }

        function formatType(typeId) {
            if (typeId === 2) return 'River';
            if (typeId === 1) return 'Lake';
            return 'Unknown';
        }
    </script>
</body>
</html>
