<html>
<head>
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="Scripts/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Content-Type" content="text/html; charset=utf-8">
    <meta name="title" content="Iceland fishing map">

    <title>Iceland fishing map</title>

    <script src="Scripts/respond.min.js"></script>
    <script src="Scripts/jquery-1.10.2.min.js"></script>
    <script src="Scripts/bootstrap.min.js"></script>
    <script src="Dal.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body class="map-full-page">
    <a class="home-link" href="CalFull.html" aria-label="Home">
        <span class="fa fa-home" aria-hidden="true"></span>
    </a>

    <div id="icelandMap" class="full-page-map"></div>

    <div class="map-overlay">
        <div class="panel panel-default map-panel">
            <div class="panel-heading calendar-menu">
                <div class="calendar-menu__title">
                    <span class="calendar-menu__title-text"><b>Iceland fishing map</b></span>
                    <span class="calendar-menu__subtitle">Track where you've fished and what is still on the list.</span>
                </div>
                <div class="calendar-menu__actions btn-group btn-group-sm" role="group" aria-label="Navigation">
                    <button class="btn btn-default" onclick="location.href='CalFull.html'">Fishing calendar</button>
                    <button class="btn btn-default" onclick="location.href='FishingPlaces.html'">Fishing places list</button>
                    <button class="btn btn-default" onclick="location.href='FishingPlaceSpots.html'">Fishing place spots</button>
                    <button class="btn btn-default" onclick="location.href='FishingPlaceWishlist.html'">Fishing place wishlist</button>
                    <button class="btn btn-default active" onclick="location.href='IcelandFishingMap.html'">Iceland map</button>
                    <button class="btn btn-default" onclick="location.href='WeatherHistory.html'">Weather history</button>
                    <button class="btn btn-default" onclick="location.href='Tides.html'">Tides</button>
                    <button class="btn btn-default" onclick="location.href='SuggestedFishingTrips.html'">Suggested trips</button>
                    <button class="btn btn-default" onclick="location.href='fishingnews.html'">Fishing news</button>
                </div>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <b>Fishing progress</b>
                            </div>
                            <div class="panel-body">
                                <p style="margin-bottom: 5px;">
                                    <span class="label label-success">Visited</span>
                                    <span id="visitedCount" class="badge">0</span>
                                </p>
                                <p style="margin-bottom: 0;">
                                    <span class="label label-warning">Still to go</span>
                                    <span id="remainingCount" class="badge">0</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <b>Legend</b>
                            </div>
                            <div class="panel-body">
                                <p style="margin-bottom: 8px;">
                                    <span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#2ecc71; margin-right:6px;"></span>
                                    Visited fishing spots
                                </p>
                                <p style="margin-bottom: 0;">
                                    <span style="display:inline-block; width:12px; height:12px; border-radius:50%; background:#f39c12; margin-right:6px;"></span>
                                    Wishlist destinations
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var map = L.map("icelandMap").setView([64.9631, -19.0208], 6);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);

        function updateCounters(totalVisited) {
            document.getElementById("visitedCount").textContent = totalVisited;
            document.getElementById("remainingCount").textContent = 0;
        }

        function addVisitedMarker(place) {
            var latitude = parseFloat(place.latitude);
            var longitude = parseFloat(place.longitude);
            if (isNaN(latitude) || isNaN(longitude)) {
                return;
            }

            var marker = L.circleMarker([latitude, longitude], {
                radius: 8,
                fillColor: "#2ecc71",
                color: "#333",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(map);

            var description = place.description ? "<br>" + place.description : "";
            marker.bindPopup("<b>" + place.name + "</b>" + description + "<br>Visited");
        }

        function loadVisitedTrips() {
            $.ajax({
                url: APIBaseUrl + "fishingmap/trips",
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var visitedPlaces = [];
                    var seenPlaces = {};

                    $.each(data, function (index, trip) {
                        if (!trip || !trip.fishingPlaceId) {
                            return;
                        }

                        if (seenPlaces[trip.fishingPlaceId]) {
                            return;
                        }

                        seenPlaces[trip.fishingPlaceId] = true;
                        visitedPlaces.push({
                            id: trip.fishingPlaceId,
                            name: trip.fishingPlaceName || "Unknown place",
                            latitude: trip.latitude,
                            longitude: trip.longitude,
                            description: trip.description || ""
                        });
                    });

                    updateCounters(visitedPlaces.length);
                    visitedPlaces.forEach(addVisitedMarker);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr.status);
                    console.log(thrownError);
                    updateCounters(0);
                }
            });
        }

        loadVisitedTrips();
    </script>
</body>
</html>
